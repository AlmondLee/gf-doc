
[TOC]

>[danger] # 数据库配置

数据库配置可以在全局配置文件config.yml中进行配置，例如：
```go
database:
    default:
        - host:     127.0.0.1
          port:     3306
          user:     root
          pass:     123456
          name:     test
          type:     mysql
          role:     master
          charset:  utf-8
          priority: 1
        - host:     127.0.0.2
          port:     3306
          user:     root
          pass:     123456
          name:     test
          type:     mysql
          role:     master
          charset:  utf-8
          priority: 1
```
也可以通过gdb包配置管理方法进行全局配置，例如：
```go
gdb.SetConfig(gdb.Config {
    "default" : gdb.ConfigGroup {
        gdb.ConfigNode {
            Host     : "127.0.0.1",
            Port     : "3306",
            User     : "root",
            Pass     : "123456",
            Name     : "test",
            Type     : "mysql",
            Role     : "master",
            Priority : 100,
        },
        gdb.ConfigNode {
            Host     : "127.0.0.2",
            Port     : "3306",
            User     : "root",
            Pass     : "123456",
            Name     : "test",
            Type     : "mysql",
            Role     : "master",
            Priority : 100,
        },
    },
})
```
gdb的数据库配置管理功能非常强大，支持分组配置、集群管理、Master-Slave模式、内置负载均衡管理等特点。
1. gdb配置管理支持对数据库配置进行分组管理，获取数据库操作对象时可以按照分组名称进行获取；
2. gdb配置管理支持多关系型数据库管理，通过Type属性进行配置；
3. gdb配置管理支持Master-Slave模式，通过Role属性进行配置；
4. gdb配置管理支持负载均衡管理，通过Priority属性进行配置，值越大，优先级越高；

数据库相关数据结构如下：
```go
type List        []Map
type Map         map[string]interface{}
type Config      map[string]ConfigGroup
type ConfigGroup []ConfigNode
type ConfigNode  struct {
    Host     string // 地址
    Port     string // 端口
    User     string // 账号
    Pass     string // 密码
    Name     string // 数据库名称
    Type     string // 数据库类型：mysql, sqlite, mssql, pgsql, oracle(目前仅支持mysql)
    Role     string // (可选，默认为master)数据库的角色，用于主从操作分离，至少需要有一个master，参数值：master, slave
    Charset  string // (可选，默认为 utf-8)编码，默认为 utf-8
    Priority int    // (可选)用于负载均衡的权重计算，当集群中只有一个节点时，权重没有任何意义
    Linkinfo string // (可选)自定义链接信息，当该字段被设置值时，以上链接字段(Host,Port,User,Pass,Name)将失效(该字段是一个扩展功能)
}
```
数据库配置管理方法列表：
```go
func AddConfigGroup(group string, nodes ConfigGroup)
func AddConfigNode(group string, node ConfigNode)
func AddDefaultConfigGroup(nodes ConfigGroup)
func AddDefaultConfigNode(node ConfigNode)
func SetConfig(c Config)
func SetDefaultGroup(groupName string)
```


>[danger] # 数据库操作

数据库操作接口：
```go
type Link interface {
    Open (c *ConfigNode) (*sql.DB, error)
    Close() error
    Query(q string, args ...interface{}) (*sql.Rows, error)
    Exec(q string, args ...interface{}) (sql.Result, error)
    Prepare(q string) (*sql.Stmt, error)

    GetAll(q string, args ...interface{}) (List, error)
    GetOne(q string, args ...interface{}) (Map, error)
    GetValue(q string, args ...interface{}) (interface{}, error)

    PingMaster() error
    PingSlave() error

    SetMaxIdleConns(n int)
    SetMaxOpenConns(n int)

    setMaster(master *sql.DB)
    setSlave(slave *sql.DB)
    setQuoteChar(left string, right string)
    setLink(link Link)
    getQuoteCharLeft () string
    getQuoteCharRight () string
    handleSqlBeforeExec(q *string) *string

    Begin() (*sql.Tx, error)
    Commit() error
    Rollback() error

    insert(table string, data Map, option uint8) (sql.Result, error)
    Insert(table string, data Map) (sql.Result, error)
    Replace(table string, data Map) (sql.Result, error)
    Save(table string, data Map) (sql.Result, error)

    batchInsert(table string, list List, batch int, option uint8) (sql.Result, error)
    BatchInsert(table string, list List, batch int) (sql.Result, error)
    BatchReplace(table string, list List, batch int) (sql.Result, error)
    BatchSave(table string, list List, batch int) (sql.Result, error)

    Update(table string, data interface{}, condition interface{}, args ...interface{}) (sql.Result, error)
    Delete(table string, condition interface{}, args ...interface{}) (sql.Result, error)

    Table(tables string) (*gLinkOp)
    From(tables string) (*gLinkOp)
}
```

需要说明一下Insert/Replace/Save三者的区别（对于BatchInsert/BatchReplace/BatchSave同理）：
1. **Insert**：使用insert into语句进行数据库写入，如果写入的数据中存在Primary Key或者Unique Key的情况，返回失败，否则写入一条新数据；
2. **Replace**：使用replace into语句进行数据库写入，如果写入的数据中存在Primary Key或者Unique Key的情况，删除原有记录，按照给定数据新写入一条新记录，否则写入一条新数据；
2. **Save**：使用insert into语句进行数据库写入，如果写入的数据中存在Primary Key或者Unique Key的情况，更新原有数据，否则写入一条新数据；

此外，gdb提供简便灵活的链式操作接口，通过gdb.Table/gdb.From方法基于数据表返回一个链式操作对象gLinkOp，该对象定义为非公开对象，可以执行以下方法。

链式操作方法列表：
```go
// 链式操作，左联表
func LeftJoin(joinTable string, on string) (*gLinkOp)
// 链式操作，右联表
func RightJoin(joinTable string, on string) (*gLinkOp)
// 链式操作，内联表
func InnerJoin(joinTable string, on string) (*gLinkOp)
// 链式操作，查询字段
func Fields(fields string) (*gLinkOp)
// 链式操作，条件
func Where(where string, args...interface{}) (*gLinkOp)
// 链式操作，group by
func GroupBy(groupby string) (*gLinkOp)
// 链式操作，order by
func OrderBy(orderby string) (*gLinkOp)
// 链式操作，limit
func Limit(start int, limit int) (*gLinkOp)
// 链式操作，操作数据记录项
func Data(data interface{}) (*gLinkOp)
// 链式操作，操作数据记录项列表
func List(list List) (*gLinkOp)
// 链式操作， CURD - Insert/BatchInsert
func Insert() (sql.Result, error)
// 链式操作， CURD - Replace/BatchReplace
func Replace() (sql.Result, error)
// 链式操作， CURD - Save/BatchSave
func Save() (sql.Result, error)
// 链式操作， CURD - Update
func Update() (sql.Result, error)
// 链式操作， CURD - Delete
func Delete() (sql.Result, error)
// 设置批处理的大小
func Batch(batch int) *gLinkOp
// 链式操作，select
func Select() (List, error)
// 链式操作，查询所有记录
func All() (List, error)
// 链式操作，查询单条记录
func One() (Map, error)
// 链式操作，查询字段值
func Value() (interface{}, error)
```


>[danger] # 数据库示例

https://gitee.com/johng/gf/blob/master/geg/database/mysql/mysql.go

>[success] ## 基本操作
1. 获取数据库操作对象
```go
// 获取默认配置的数据库对象(配置名称为"default")
db := gins.Database()
// 获取配置分组名称为"user-center"的数据库对象
db := gins.Database("user-center")
```
2. 数据写入
```go
r, err := db.Insert("user", gdb.Map {
    "name": "john",
})
```
3. 数据查询(列表)
```go
list, err := db.GetAll("select * from user limit 2")
```

4. 数据查询(单条)
```go
list, err := db.GetOne("select * from user limit 2")
```

5. 数据保存
```go
r, err := db.Save("user", gdb.Map {
        "uid"  :  1,
        "name" : "john",
    })
```

6. 批量操作
```go
// BatchInsert/BatchReplace/BatchSave
_, err := db.BatchInsert("user", gdb.List {
    {"name": "john_" + strconv.FormatInt(time.Now().UnixNano(), 10)},
    {"name": "john_" + strconv.FormatInt(time.Now().UnixNano(), 10)},
    {"name": "john_" + strconv.FormatInt(time.Now().UnixNano(), 10)},
    {"name": "john_" + strconv.FormatInt(time.Now().UnixNano(), 10)},
}, 10)
```

7. 数据更新/删除
```go
// db.Update/db.Delete
r, err := db.Update("user", gdb.Map {"name": "john1"}, "uid=?", 1)
r, err := db.Update("user", "name='john2'", "uid=1")
r, err := db.Update("user", "name=?", "uid=?", "john2", 1)
```

>[success] ## 链式操作

1. 链式查询
```go
r, err := db.Table("user u").LeftJoin("user_detail ud", "u.uid=ud.uid").Fields("u.*, ud.site").Where("u.uid > ?", 1).Limit(0, 2).Select()
r, err := db.Table("user u").LeftJoin("user_detail ud", "u.uid=ud.uid").Fields("u.*,ud.site").Where("u.uid=?", 1).One()
r, err := db.Table("user u").LeftJoin("user_detail ud", "u.uid=ud.uid").Fields("ud.site").Where("u.uid=?", 1).Value()
```

2. 链式更新
```go
r, err := db.Table("user").Data(gdb.Map{"name" : "john2"}).Where("name=?", "john").Update()
r, err := db.Table("user").Data("name='john3'").Where("name=?", "john2").Update()
```

3. 链式批量写入
```go
r, err := db.Table("user").Data(gdb.List{
    {"name": "john_1"},
    {"name": "john_2"},
    {"name": "john_3"},
    {"name": "john_4"},
}).Insert()
```

可以指定批量操作中分批写入数据库的每批次写入条数数量：
```go
r, err := db.Table("user").Data(gdb.List{
    {"name": "john_1"},
    {"name": "john_2"},
    {"name": "john_3"},
    {"name": "john_4"},
}).Batch(2).Insert()
```

4. 链式批量保存
```go
r, err := db.Table("user").Data(gdb.List{
    {"id":1, "name": "john_1"},
    {"id":2, "name": "john_2"},
    {"id":3, "name": "john_3"},
    {"id":4, "name": "john_4"},
}).Save()
```





