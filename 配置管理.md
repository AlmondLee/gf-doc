[TOC]


gf的配置管理由gcfg包提供支持，gcfg包是读取安全的，仅提供配置文件读取功能，不提供数据写入/修改功能，**支持的数据文件格式包括： JSON、XML、YAML/YML、TOML**。如果想要支持对数据文件的读取和修改，并且可以进行数据格式转换，请参看gparser包。

>[danger] # 方法列表

配置管理相关方法列表：

```go
func New(path string) *Config
func (c *Config) Get(pattern string, file ...string) interface{}
func (c *Config) GetArray(pattern string, file ...string) []interface{}
func (c *Config) GetBool(pattern string, file ...string) bool
func (c *Config) GetFloat32(pattern string, file ...string) float32
func (c *Config) GetFloat64(pattern string, file ...string) float64
func (c *Config) GetInt(pattern string, file ...string) int
func (c *Config) GetMap(pattern string, file ...string) map[string]interface{}
func (c *Config) GetPath() string
func (c *Config) GetString(pattern string, file ...string) string
func (c *Config) GetUint(pattern string, file ...string) uint
func (c *Config) SetPath(path string)
```

gcfg包最大的特点是支持按层级获取配置数据，层级访问通过英文"."号指定，其中pattern参数和[gjson包](JSON模块.md)的pattern参数一致。参数files指定需要读取的配置文件目录下的文件名称，是一个可选参数，默认为config.yml（即读取config.yml配置文件数据）。yml类型文件也是推荐的配置文件格式。

为简化Web Server的运行配置，ghttp默认配置目录为当前执行文件目录，并将配置路径下的config.yml配置文件作为默认全局配置文件，并可在运行时通过```SetPath```随时修改配置目录。

>[danger] # 单例管理

gcfg集成到了gins单例管理器中，可以方便地通过```gins.Config()```获取默认的全局配置管理对象，默认是读取当前执行目录（执行文件所在目录）下的```config.yml```文件。

>[danger] # 使用示例

我们有两种方式进行配置文件的管理，单独使用cfg包，或者使用封装的gins包金泉全局管理。

1. **独立使用cfg包进行配置文件管理**
	由于gf框架的所有组件都是低耦合设计的，因为可以单独使用cfg包进行配置管理，这种方式相对来说比较简单。请查看以下示例。
	为示例需要这里将同一个配置文件的内容拆分为两个配置文件，```redis.yml```和```memcache.yml```，都放到一个配置文件管理目录 ```/var/www/config/```下进行统一管理。配置文件的内容如下：
    ```yml
    # redis.yml - redis服务器配置信息
    redis-cache:
        - host:   192.168.0.100
          port:   6379
          db:     0
        - host:   192.168.0.100
          port:   6379
          db:     1
    redis-disk:
        - host:   192.168.0.100
          port:   6380
          db:     0
        - host:   192.168.0.100
          port:   6380
          db:     1
    ```
    ```yml
    # memcache.yml - memcache服务器配置信息
    - host:   192.168.0.101
      port:   11211
      expire: 60
    - host:   192.168.0.102
      port:   11211
      expire: 60
    ```
    分别读取指定redis配置信息以及所有的memcache配置信息：
    gitee.com/johng/gf/blob/master/geg/os/gcfg/gcfg1.go
    ```go
    package main
    
    import (
        "fmt"
        "gitee.com/johng/gf/g/os/gcfg"
    )
    
    func main() {
        c              := gcfg.New("/var/www/config")
        redisConfig    := c.GetArray("redis-cache", "redis.yml")
        memcacheConfig := c.GetArray("", "memcache.yml")
        fmt.Println(redisConfig)
        fmt.Println(memcacheConfig)
    }
    
    // 输出：
    // [map[db:0 host:192.168.0.100 port:6379] map[db:1 host:192.168.0.100 port:6379]]
    // [map[port:11211 expire:60 host:192.168.0.101] map[expire:60 host:192.168.0.102 port:11211]]
    ```
    以上示例代码中，我们可以通过```pattern```参数指定获取的参数项，如果获取配置文件的所有配置信息，那么```pattern```传递一个**空的字符串**即可。第二个文件参数指定需要操作的配置文件名称，不同的配置文件需要传递不同的配置文件参数，因此相对来说会比较繁琐。我们可以将所有这些基础配置都放到统一的配置文件中，这样我们可以只需要通过```pattern```参数来做区分不同的配置项即可，方便调用，因此我们可以做如下改进。
    将所有配置放到```config.yml```配置文件中，此时```config.yml```的配置文件内容如下：
    ```yml
    # config.yml
    redis:
      cache:
        - host:   192.168.0.100
          port:   6379
          db:     0
        - host:   192.168.0.100
          port:   6379
          db:     1
      disk:
        - host:   192.168.0.100
          port:   6380
          db:     0
        - host:   192.168.0.100
          port:   6380
          db:     1

    memcache:
      - host:   192.168.0.101
        port:   11211
        expire: 60
      - host:   192.168.0.102
        port:   11211
        expire: 60
    ```
    那么假如我们通过以下程序获取memcache的配置：
    gitee.com/johng/gf/blob/master/geg/os/gcfg/gcfg2.go
    ```go
    package main

    import (
        "fmt"
        "gitee.com/johng/gf/g/os/gcfg"
    )

    func main() {
        c := gcfg.New("/var/www/config")
        v := c.GetArray("memcache")
        fmt.Println(v)
    }
    
    // 输出：
    // [map[port:11211 expire:60 host:192.168.0.101] map[expire:60 host:192.168.0.102 port:11211]]
    ```
    可以看到，读取配置的方式简化了不少。因此在实际项目开发中，建议尽可能地将配置（特别是频繁使用的配置）统一存放到```config.yml```文件中进行统一管理，大大提高开发及维护效率。
    
    此外有一点需要提醒的是，如果调用的方法与配置项的类型不匹配时，```pattern```将会检索失败，返回空值（对应类型的空值）。例如，假如配置项是map类型，而使用```GetArray```进行获取时，将会得到一个nil。
    
    
1. **通过全局配置管理对象进行配置文件管理**
    我们再来一个看示例，演示如何读取全局配置的信息。需要注意的是，全局配置是与框架相关的，因此统一使用gins单例管理器进行了封装。以下是一个默认的全局配置文件，包含了模板引擎的目录配置以及MySQL数据库集群(两台master)的配置。

    gitee.com/johng/gf/blob/master/geg/frame/config.yaml

    ```yml
    # 模板引擎目录
    viewpath: /home/www/templates/
    # MySQL数据库配置
    database:
        default:
            - host:     127.0.0.1
              port:     3306
              user:     root
              pass:     123456
              name:     test
              type:     mysql
              role:     master
              charset:  utf-8
              priority: 1
            - host:     127.0.0.1
              port:     3306
              user:     root
              pass:     123456
              name:     test
              type:     mysql
              role:     master
              charset:  utf-8
              priority: 1
    ```

    我们来读取第一个数据库配置的host信息，并输出到浏览器上：

    gitee.com/johng/gf/blob/master/geg/frame/mvc/controller/demo/config.go

    ```go
    package demo

    import (
        "gitee.com/johng/gf/g/net/ghttp"
        "gitee.com/johng/gf/g/frame/gins"
    )

    func init() {
        ghttp.GetServer().BindHandler("/config", func (r *ghttp.Request) {
            r.Response.Write(gins.Config().GetString("database.default.0.host"))
        })
    }
    ```
    以上示例为读取数据库的第一个配置的host信息。

    运行main.go，访问：```http://127.0.0.1:8199/config```，可以看到页面输出：
	```html
    127.0.0.1
	```
    可以看到，gf框架的配置管理可以通过英文“.”号进行层级访问（数组默认从0开始），pattern参数“database.default.0.host”表示读取database配置项中default数据库集群中的第0项数据库服务器的host数据。

>[danger] # 修改配置目录

配置管理器作为gf框架的核心组件，可以通过以下方式修改配置管理器的默认配置文件查找目录：
1. (推荐)单例模式获取全局Config对象，通过```SetPath```方法手动修改
2. 修改命令行启动参数 - ```cfgpath```
3. 修改环境变量 - ```gf.cfgpath```

例如，我们的执行程序文件为main，那么可以通过以下方式修改配置管理器的配置文件目录(Linux下)：

1. (推荐)通过单例模式
	```go
    gins.Config().SetPath("/opt/config")
    ```
3. 通过命令行参数
    ```shell
    ./main --cfgpath=/opt/config/
    ```
1. 通过环境变量
    * 启动时修改环境变量：
        ```shell
        gf.cfgpath=/opt/config/; ./main
        ```
    * 使用genv包来修改环境变量：
        ```go
        genv.Set("gf.cfgpath", "/opt/config")
        ```


